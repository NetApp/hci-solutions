heat_template_version: queens
description: Configure NetApp SolidFire on controller nodes using ibft0 interface for Swift

parameters:
  server:
    description: ID of the controller node to apply this config to
    type: string
  SolidFireSVIP:
    description: The SVIP for the SolidFire Array
    type: string
  SwiftSolidFireLuns:
    description: Number of SolidFire LUNs to be used for Swift
    type: string

resources:
   SwiftNetAppSFConfig:
     type: OS::Heat::SoftwareConfig
     properties:
       group: script
       config:
         str_replace:
           template: |
             #!/bin/bash
             # Correct the default initiator name
             # so the controller can login into SolidFire LUN
             printf "InitiatorName=iqn.1994-05.com.redhat:$(hostname -s) \n" > /etc/iscsi/initiatorname.iscsi
             touch /etc/iscsi/.initiator_reset
             iscsiadm --mode discovery --type sendtargets --portal=_SFSVIP_
             iscsiadm --mode node --login 
             mkfs.xfs -f /dev/sdc
             mkdir -p /srv/node/sdc
             mount -t xfs -o noatime,nodiratime,nobarrier,logbufs=8,_netdev /dev/sdc /srv/node/sdc
           params:
             _SFSVIP_: {get_param: SolidFireSVIP}
             _LUNS_: {get_param: SwiftSolidFireLuns}

   SwiftNetAppSFDeployment:
     type: OS::Heat::SoftwareDeployment
     properties:
       config: {get_resource: SwiftNetAppSFConfig}
       server: {get_param: server }
       actions: ['CREATE']

outputs:
  deploy_stdout:
    description: Deployment reference
    value: {get_attr: [SwiftNetAppSFDeployment, deploy_stdout]}
